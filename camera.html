<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>哈威SSR团队作品前端展示</title>

  <!-- 样式与库 -->
  <link href="css/sb-admin-2.min.css" rel="stylesheet">
  <link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet">
  <link href="vendor/toastr/toastr.min.css" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/rtsp-relay/browser/rtsp-relay.min.js"></script>
  <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
  <script src="vendor/toastr/toastr.min.js"></script>

  <style>
    .camera-container{padding:20px;max-width:800px;margin:0 auto;}
    .camera-container video{width:100%;background:#000;}
    #modeBtnGroup{position:fixed;bottom:20px;right:20px;z-index:10000;display:flex;gap:10px;}
    #modeBtnGroup .btn{padding:1px 6px;min-width:60px;}
  </style>
</head>

<body id="page-top">
<div id="wrapper">
  <!-- ===== 左侧导航略 ===== -->
  <!-- Sidebar -->
    <ul class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion" id="accordionSidebar">
      <!-- Sidebar Brand -->
      <a class="sidebar-brand d-flex align-items-center justify-content-center" href="first_page.html">
        <div class="sidebar-brand-icon rotate-n-15">
          <i class="fas fa-laugh-wink"></i>
        </div>
        <div class="sidebar-brand-text mx-3">SSR团队</div>
      </a>
      <hr class="sidebar-divider my-0">
      <!-- Nav Item - Dashboard -->
      <li class="nav-item active">
        <a class="nav-link" href="first_page.html">
          <i class="fas fa-fw fa-tachometer-alt"></i>
          <span>首页展示</span>
        </a>
      </li>
      <hr class="sidebar-divider">
      <div class="sidebar-heading">数据图表</div>
      <li class="nav-item">
        <a class="nav-link" href="chart.html">
          <i class="fas fa-fw fa-chart-area"></i>
          <span>图表</span>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="tables.html">
          <i class="fas fa-fw fa-table"></i>
          <span>表格</span>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link collapsed" href="XBox.html">
          <i class="fas fa-fw fa-cog"></i>
          <span>手柄效果</span>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="camera.html">
          <i class="fas fa-fw fa-camera"></i>
          <span>摄像头读取</span>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="http://localhost:8001/vendor/three.js-r161/examples/simple.html">
          <i class="fas fa-fw fa-wrench"></i>
          <span>模型展示</span>
        </a>
      </li>
    </ul>
    <!-- End of Sidebar -->

    <!-- Content Wrapper -->
    <div id="content-wrapper" class="d-flex flex-column">
      <!-- Main Content -->
      <div id="content">
        <!-- Topbar -->
        <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow">
          <button id="sidebarToggleTop" class="btn btn-link d-md-none rounded-circle mr-3">
            <i class="fa fa-bars"></i>
          </button>
          <ul class="navbar-nav ml-auto">
            <li class="nav-item dropdown no-arrow">
              <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-toggle="dropdown"
                aria-haspopup="true" aria-expanded="false">
                <span class="mr-2 d-none d-lg-inline text-gray-600 small">哈威SSR团队研发</span>
                <img class="img-profile rounded-circle" src="img/picture.png">
              </a>
            </li>
          </ul>
        </nav>
        <!-- End of Topbar -->
  <!-- ===== 主内容区 ===== -->
  <div id="content-wrapper" class="d-flex flex-column">
    <div id="content">
      <!-- ===== 顶栏略 ===== -->

      <div class="container-fluid">

        <!-- 本地摄像头 -->
        <div id="cameraContainer" class="camera-container">
          <div class="card shadow mb-4">
            <div class="card-header py-3"><h6 class="m-0 font-weight-bold text-primary">本地摄像头</h6></div>
            <div class="card-body text-center">
              <video id="localVideo" autoplay playsinline muted></video>
              <div class="camera-controls mt-4">
                <button id="startCamera"  class="btn btn-success"><i class="fas fa-video"></i> 开启摄像头</button>
                <button id="takePhoto"    class="btn btn-primary"  disabled><i class="fas fa-camera"></i> 拍照</button>
                <button id="switchCamera" class="btn btn-secondary"><i class="fas fa-sync-alt"></i> 切换摄像头</button>
              </div>
              <canvas id="canvas" width="640" height="480" style="display:none"></canvas>
              <img    id="photo"  style="display:none;max-width:100%">
            </div>
          </div>
        </div>

        <!-- RTSP -->
        <div id="rtspContainer" class="camera-container" style="display:none">
          <div class="card shadow mb-4">
            <div class="card-header py-3"><h6 class="m-0 font-weight-bold text-primary">RTSP 实时流</h6></div>
            <div class="card-body text-center">
              <video id="rtspVideo" controls autoplay muted playsinline></video>
            </div>
          </div>
        </div>

        <!-- WebRTC -->
        <div id="webrtcContainer" class="camera-container" style="display:none">
          <div class="card shadow mb-4">
            <div class="card-header py-3"><h6 class="m-0 font-weight-bold text-primary">WebRTC 实时流</h6></div>
            <div class="card-body text-center">
              <video id="webrtcVideo" controls autoplay muted playsinline></video>
            </div>
          </div>
        </div>

      </div><!-- /.container-fluid -->
    </div><!-- /#content -->

    <footer class="sticky-footer bg-white"><div class="container my-auto"><div class="copyright text-center my-auto">© 2025 哈威SSR团队研发</div></div></footer>
  </div><!-- /#content-wrapper -->
</div><!-- /#wrapper -->

<!-- 三模式切换 -->
<div id="modeBtnGroup">
  <button id="modeCameraBtn" class="btn btn-primary">本地摄像头</button>
  <button id="modeRTSPBtn"   class="btn btn-secondary">RTSP 流</button>
  <button id="modeWebRTCBtn" class="btn btn-secondary">WebRTC 流</button>
</div>

<!-- 必要脚本 -->
<script src="vendor/jquery/jquery.min.js"></script>
<script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="vendor/jquery-easing/jquery.easing.min.js"></script>
<script src="js/sb-admin-2.min.js"></script>

<script>
/* ---------- 本地摄像头 ---------- */
let camStream=null,facing='user';
const localVideo=document.getElementById('localVideo');

$('#startCamera').on('click',async()=>{
  try{
    camStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:facing}});
    localVideo.srcObject=camStream;
    $('#startCamera').prop('disabled',true);
    $('#takePhoto').prop('disabled',false);
  }catch(e){toastr.error('无法访问摄像头');}
});
$('#switchCamera').on('click',async()=>{
  if(camStream)camStream.getTracks().forEach(t=>t.stop());
  facing=facing==='user'?'environment':'user';
  try{
    camStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:facing}});
    localVideo.srcObject=camStream;
  }catch{toastr.warning('切换失败');}
});
$('#takePhoto').on('click',()=>{
  const c=document.getElementById('canvas'),ctx=c.getContext('2d');
  ctx.drawImage(localVideo,0,0,c.width,c.height);
  $('#photo').attr('src',c.toDataURL('image/png')).show();
});
function stopCamera(){if(camStream)camStream.getTracks().forEach(t=>t.stop());camStream=null;$('#startCamera').prop('disabled',false);$('#takePhoto').prop('disabled',true);}

/* ---------- RTSP ---------- */
let rtspPlayer=null;
function startRTSP(){
  if(rtspPlayer) return;            // 已启动直接返回
  rtspPlayer=window.RTSPRelay.startPlayer({
    // url:'rtsp://localhost:8554/yourStream',
    // url: 'rtsp://wowzaec2demo.streamlock.net/vod/mp4:BigBuckBunny_115k.mov',
    url: 'rtsp://rtspstream:jNQoVgriRmI08TnF_DLQt@zephyr.rtsp.stream/movie',
    element:document.getElementById('rtspVideo'),
    protocol:'tcp'
  });
}
function stopRTSP(){
  if(rtspPlayer){rtspPlayer.close();rtspPlayer=null;}
  document.getElementById('rtspVideo').src='';
}

/* ---------- WebRTC ---------- */
let pc=null,ws=null;
function startWebRTC(){
  if(pc) return;
  const video=document.getElementById('webrtcVideo');
  pc=new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
  pc.ontrack=e=>video.srcObject=e.streams[0];
  ws=new WebSocket('ws://localhost:8889');
  ws.onmessage=async({data})=>{
    const msg=JSON.parse(data);
    if(msg.sdp){
      await pc.setRemoteDescription(msg.sdp);
      if(msg.sdp.type==='offer'){
        const ans=await pc.createAnswer();
        await pc.setLocalDescription(ans);
        ws.send(JSON.stringify({sdp:pc.localDescription}));
      }
    }else if(msg.ice){await pc.addIceCandidate(msg.ice);}
  };
  pc.onicecandidate=e=>{if(e.candidate)ws.send(JSON.stringify({ice:e.candidate}));};
}
function stopWebRTC(){if(pc){pc.close();pc=null;}if(ws){ws.close();ws=null;}document.getElementById('webrtcVideo').srcObject=null;}

/* ---------- 模式切换 ---------- */
function setMode(show){
  $('#cameraContainer,#rtspContainer,#webrtcContainer').hide();
  $('#'+show).show();
  $('#modeBtnGroup .btn').removeClass('btn-primary').addClass('btn-secondary');
  $('#mode'+(show==='cameraContainer'?'Camera':show==='rtspContainer'?'RTSP':'WebRTC')+'Btn').removeClass('btn-secondary').addClass('btn-primary');
}
$('#modeCameraBtn').on('click',()=>{stopRTSP();stopWebRTC();setMode('cameraContainer');});
$('#modeRTSPBtn').  on('click',()=>{
  stopCamera();
  stopWebRTC();
  setMode('rtspContainer');
  // 设置video源为demo2.mp4
  const rtspVideo = document.getElementById('rtspVideo');
  rtspVideo.src = './demo2.mp4';
  rtspVideo.load();
  rtspVideo.play();
});
$('#modeWebRTCBtn').on('click',()=>{
  stopCamera();
  stopRTSP();
  setMode('webrtcContainer');
  // 设置video源为demo2.mp4
  const webrtcVideo = document.getElementById('webrtcVideo');
  webrtcVideo.src = './demo2.mp4';
  webrtcVideo.load();
  webrtcVideo.play();
});

/* 默认本地摄像头 */
$('#modeCameraBtn').click();

/* ---------- demo.mp4 兼容 ---------- */
function playDemo(videoEl){
  stopRTSP();stopWebRTC();
  const v=document.getElementById(videoEl);
  v.src='demo.mp4'; v.load(); v.play();
}

/* 若需要手动测试 demo，可打开下列语句 */
playDemo('rtspVideo');   // 测 RTSP 区域
playDemo('webrtcVideo'); // 测 WebRTC 区域
</script>
</body>
</html>
