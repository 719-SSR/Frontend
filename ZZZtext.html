<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>摄像头/RTSP/WebRTC 演示切换</title>
  <link href="css/sb-admin-2.min.css" rel="stylesheet">
  <link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
  <link href="vendor/toastr/toastr.min.css" rel="stylesheet">

  <!-- RTSP-Relay -->
  <script src="https://cdn.jsdelivr.net/npm/rtsp-relay/browser/rtsp-relay.min.js"></script>
  <!-- WebRTC adapter -->
  <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
  <script src="vendor/toastr/toastr.min.js"></script>

  <style>
    .camera-container { padding:20px; max-width:800px; margin:20px auto; }
    .camera-container video { width:100%; background:#000; }
    .btn-sm { margin:0 0.25rem; }
  </style>
</head>
<body>

  <div class="camera-container" id="rtspContainer" style="display:none">
    <h4>RTSP 实时流</h4>
    <video id="rtspPlayer" controls autoplay muted loop></video>
    <div class="mt-2">
      <button id="rtspBtnStream" class="btn btn-primary btn-sm">RTSP 流</button>
      <button id="rtspBtnDemo"   class="btn btn-secondary btn-sm">演示视频</button>
    </div>
  </div>

  <div class="camera-container" id="webrtcContainer" style="display:none">
    <h4>WebRTC 实时流</h4>
    <video id="webrtcPlayer" controls autoplay playsinline></video>
    <div class="mt-2">
      <button id="webrtcBtnStream" class="btn btn-primary btn-sm">WebRTC 流</button>
      <button id="webrtcBtnDemo"   class="btn btn-secondary btn-sm">演示视频</button>
    </div>
  </div>

  <div class="camera-container" id="modeBtnGroup">
    <button id="modeRTSPBtn"   class="btn btn-primary">RTSP 模式</button>
    <button id="modeWebRTCBtn" class="btn btn-secondary">WebRTC 模式</button>
  </div>

  <script src="vendor/jquery/jquery.min.js"></script>
  <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="vendor/jquery-easing/jquery.easing.min.js"></script>
  <script src="js/sb-admin-2.min.js"></script>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // --- 全局引用 ---
    const rtspPlayer    = document.getElementById('rtspPlayer');
    const rtspBtnStream = document.getElementById('rtspBtnStream');
    const rtspBtnDemo   = document.getElementById('rtspBtnDemo');

    const webrtcPlayer    = document.getElementById('webrtcPlayer');
    const webrtcBtnStream = document.getElementById('webrtcBtnStream');
    const webrtcBtnDemo   = document.getElementById('webrtcBtnDemo');

    const rtspDiv   = document.getElementById('rtspContainer');
    const webrtcDiv = document.getElementById('webrtcContainer');

    // --- RTSP 播放/停止 ---
    let rtspInstance;
    function startRTSP() {
      // 停掉已有实例
      if (rtspInstance) {
        window.RTSPRelay.stopPlayer({ element: rtspPlayer });
      }
      // 启动新的
      rtspInstance = window.RTSPRelay.startPlayer({
        url: 'rtsp://localhost:8554/yourStream',
        element: rtspPlayer,
        protocol: 'tcp'
      });
    }

    // 演示视频切换
    rtspBtnStream.addEventListener('click', () => {
      rtspPlayer.pause();
      startRTSP();
      rtspBtnStream.classList.replace('btn-secondary','btn-primary');
      rtspBtnDemo.classList.replace('btn-primary','btn-secondary');
    });

    rtspBtnDemo.addEventListener('click', () => {
      // 停掉 RTSP
      window.RTSPRelay.stopPlayer({ element: rtspPlayer });
      rtspPlayer.src = '/videos/demo.mp4';  // 请替换为你的示例视频路径
      rtspPlayer.play();
      rtspBtnDemo.classList.replace('btn-secondary','btn-primary');
      rtspBtnStream.classList.replace('btn-primary','btn-secondary');
    });

    // --- WebRTC 播放/停止 ---
    let pc, ws;
    function startWebRTC() {
      if (pc) stopWebRTC();

      pc = new RTCPeerConnection({ iceServers:[{urls:'stun:stun.l.google.com:19302'}] });
      pc.ontrack = ({ streams }) => webrtcPlayer.srcObject = streams[0];

      ws = new WebSocket('ws://localhost:8889');
      ws.onmessage = async ({ data }) => {
        const msg = JSON.parse(data);
        if (msg.sdp) {
          await pc.setRemoteDescription(msg.sdp);
          if (msg.sdp.type==='offer') {
            const ans = await pc.createAnswer();
            await pc.setLocalDescription(ans);
            ws.send(JSON.stringify({ sdp: pc.localDescription }));
          }
        } else if (msg.ice) {
          await pc.addIceCandidate(msg.ice);
        }
      };
      pc.onicecandidate = ({candidate}) => candidate && ws.send(JSON.stringify({ ice:candidate }));
    }
    function stopWebRTC() {
      if (pc) { pc.close(); pc=null; }
      if (ws) { ws.close(); ws=null; }
      webrtcPlayer.srcObject = null;
      webrtcPlayer.src = '';
    }

    webrtcBtnStream.addEventListener('click', () => {
      webrtcPlayer.pause();
      startWebRTC();
      webrtcBtnStream.classList.replace('btn-secondary','btn-primary');
      webrtcBtnDemo.classList.replace('btn-primary','btn-secondary');
    });
    webrtcBtnDemo.addEventListener('click', () => {
      stopWebRTC();
      webrtcPlayer.src = '/videos/demo.mp4';  // 请替换为示例视频
      webrtcPlayer.play();
      webrtcBtnDemo.classList.replace('btn-secondary','btn-primary');
      webrtcBtnStream.classList.replace('btn-primary','btn-secondary');
    });

    // --- 模式切换 ---
    document.getElementById('modeRTSPBtn').addEventListener('click', () => {
      stopWebRTC();
      rtspDiv.style.display='block'; webrtcDiv.style.display='none';
      document.getElementById('modeRTSPBtn').classList.replace('btn-secondary','btn-primary');
      document.getElementById('modeWebRTCBtn').classList.replace('btn-primary','btn-secondary');
      rtspBtnStream.click();  // 默认启动真实流
    });
    document.getElementById('modeWebRTCBtn').addEventListener('click', () => {
      window.RTSPRelay.stopPlayer({ element: rtspPlayer });
      rtspDiv.style.display='none'; webrtcDiv.style.display='block';
      document.getElementById('modeWebRTCBtn').classList.replace('btn-secondary','btn-primary');
      document.getElementById('modeRTSPBtn').classList.replace('btn-primary','btn-secondary');
      webrtcBtnStream.click();  // 默认启动真实流
    });

    // 默认进入 RTSP 模式
    document.getElementById('modeRTSPBtn').click();
  });
  </script>
</body>
</html>
